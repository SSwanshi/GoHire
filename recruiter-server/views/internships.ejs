<%- include('layout/header') %>

<% if (successMessage) { %>
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white p-3 rounded-md shadow-md mt-20">
        <%= successMessage %>
    </div>
    <script>
        setTimeout(() => {
            document.getElementById("toast").style.display = "none";
        }, 3000);
    </script>
<% } %>

<h2 class="font-bold mt-10 flex justify-center font-sans text-xl">Here is your list of recently added Internships</h2>

<section class="my-10 flex justify-center">
    <div class="w-full max-w-6xl">
        <table class="w-full text-left border-collapse border border-gray-300">
            <thead>
                <tr class="text-gray-700 bg-gray-200">
                    <th class="px-6 py-3 border border-gray-300">Company</th>
                    <th class="px-6 py-3 border border-gray-300">Internship Title</th>
                    <th class="px-6 py-3 border border-gray-300">Stipend (in K)</th>
                    <th class="px-6 py-3 border border-gray-300">Location</th>
                    <th class="px-6 py-3 border border-gray-300">Duration</th>
                    <th class="px-6 py-3 border border-gray-300">Opportunities</th>
                    <th class="px-6 py-3 border border-gray-300">Deadline</th>
                    <th class="px-6 py-3 border border-gray-300 text-center">Action</th>
                    <th class="px-6 py-3 border border-gray-300">Applications</th>
                </tr>
            </thead>
            <tbody>
                <% if (internships.length > 0) { %>
                    <% for (var i = 0; i < internships.length; i++) { %>
                        <tr class="hover:bg-gray-100">
                            <td class="px-6 py-4 border border-gray-300">
                                <% if (internships[i].intCompany && internships[i].intCompany.logoId) { %>
                                    <img src="/recruiter/logo/<%= internships[i].intCompany.logoId %>" 
                                         alt="<%= internships[i].intCompany.companyName %> Logo" 
                                         class="h-10 w-10 rounded-full">
                                <% } else { %>
                                    <p class="text-gray-500">No Logo</p>
                                <% } %>
                            </td>
                            <td class="px-6 py-4 border border-gray-300"><%= internships[i].intTitle %></td>
                            <td class="px-6 py-4 border border-gray-300"><%= internships[i].intStipend %></td>
                            <td class="px-6 py-4 border border-gray-300"><%= internships[i].intLocation %></td>
                            <td class="px-6 py-4 border border-gray-300"><%= internships[i].intDuration %></td>
                            <td class="px-6 py-4 border border-gray-300"><%= internships[i].intPositions %></td>
                            <td class="px-6 py-4 border border-gray-300">
                                <%= new Date(internships[i].intExpiry).toLocaleDateString('en-GB') %>
                              </td>
                              
                            <td class="px-6 py-4 border border-gray-300 flex items-center justify-center gap-4 mt-3">
                                <button type="button" 
                                        onclick="deleteInternship('<%= internships[i]._id %>')" 
                                        class="bg-red-500 hover:bg-red-800 text-white font-bold py-2 px-4 rounded">
                                    Delete
                                </button>
                                <a href="/recruiter/edit-internship/<%= internships[i]._id %>" 
                                    class="bg-green-500 hover:bg-green-800 text-white font-bold py-2 px-4 rounded inline-block text-center">
                                    Edit
                                 </a>
                                 
                            </td>
                            <td class="px-6 py-4 border border-gray-300">
                                <a href="/internapplicants/<%= internships[i]._id %>" 
                                   class="bg-blue-400 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-block text-center">
                                    View Applications
                                </a>
                            </td>
                        </tr>
                    <% } %>
                <% } else { %>
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">No internships added yet.</td>
                    </tr>
                <% } %>
                
            </tbody>
            
        </table>
    </div>
</section>

<script>
function deleteInternship(internshipId) {
  if (!confirm('Are you sure you want to delete this internship? This action cannot be undone.')) {
    return;
  }

  // Show loading state
  const button = document.querySelector(`button[onclick*="${internshipId}"]`);
  const originalText = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '⏳ Deleting...';

  // Create XMLHttpRequest
  const xhr = new XMLHttpRequest();
  xhr.open('POST', `/recruiter/delete-intern/${internshipId}`, true);
  xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
  
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        if (response.success) {
          // Show success message
          showNotification(response.message, 'success');
          
          // Remove the row from table
          const row = button.closest('tr');
          row.style.transition = 'opacity 0.3s ease';
          row.style.opacity = '0';
          setTimeout(() => {
            row.remove();
          }, 300);
        } else {
          showNotification(response.message, 'error');
          // Reset button
          button.disabled = false;
          button.innerHTML = originalText;
        }
      } else {
        showNotification('Error deleting internship', 'error');
        // Reset button
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }
  };
  
  xhr.send();
}

function showNotification(message, type) {
  // Remove existing notifications
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  
  const notification = document.createElement('div');
  notification.className = `notification fixed top-5 right-5 p-4 rounded-md shadow-lg z-50 ${
    type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
  }`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 3000);
}
</script>

<%- include('layout/footer') %> 